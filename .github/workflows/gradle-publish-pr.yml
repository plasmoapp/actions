name: Gradle Publish PR

on:
  workflow_call:
    inputs:
      gradle_publish_command:
        description: 'Gradle command to use for publish'
        required: false
        type: string
        default: 'publishAllPublicationsToPlasmoverseSnapshotsRepository'
      java_version:
        required: false
        type: string
        default: '21'
      artifact_group:
        description: 'Artifact group'
        required: true
        type: string
      artifact_id:
        description: 'Artifact id'
        required: true
        type: string
      build_workflow_name:
        description: 'Name of the build workflow to wait for'
        required: false
        type: string
        default: 'Build PR'
    secrets:
      app_id:
        description: 'GitHub App ID'
        required: true
      app_private_key:
        description: 'GitHub App Private Key'
        required: true
      maven_username:
        description: 'Maven username'
        required: true
      maven_password:
        description: 'Maven password'
        required: true

jobs:
  create-comment:
    name: Create PR Comment
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - name: Check if comment exists
        id: check-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Publish to maven')
            );

            return botComment ? botComment.id : null;

      - name: Create comment with checkbox
        if: steps.check-comment.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `- [ ] Publish to maven snapshots repository`
            });

  publish:
    name: Publish PR to Maven
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.action == 'edited' &&
       github.event.issue.pull_request)
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - name: Check if edited comment is bot comment
        if: github.event_name == 'issue_comment' && github.event.action == 'edited'
        id: verify-bot-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const comment = context.payload.comment;
            const isBotComment = comment.user.type === 'Bot' &&
              comment.body.includes('Publish to maven snapshots repository');
            return isBotComment;

      - name: Get PR number
        if: |
          github.event_name == 'workflow_run' ||
          (github.event_name == 'issue_comment' && steps.verify-bot-comment.outputs.result == 'true')
        id: pr-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            if (context.eventName === 'issue_comment') {
              return context.payload.issue.number;
            } else if (context.eventName === 'workflow_run') {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open'
              });
              return prs[0]?.number || null;
            }
            return null;

      - name: Check if publish is enabled
        id: check-publish
        if: |
          steps.pr-number.outputs.result != 'null' &&
          (github.event_name == 'workflow_run' || steps.verify-bot-comment.outputs.result == 'true')
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumber = ${{ steps.pr-number.outputs.result }};

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Publish to maven snapshots repository')
            );

            if (!botComment) {
              core.info('No publish comment found');
              return false;
            }

            const isChecked = botComment.body.includes('- [x] Publish to maven snapshots repository');
            core.info(`Publish checkbox is ${isChecked ? 'checked' : 'unchecked'}`);
            return isChecked;

      - name: Get PR details
        if: steps.check-publish.outputs.result == 'true'
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumber = ${{ steps.pr-number.outputs.result }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            return pr.head.sha;

      - name: Checkout PR
        if: steps.check-publish.outputs.result == 'true'
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ steps.pr-number.outputs.result }}/merge

      - name: Set up JDK
        if: steps.check-publish.outputs.result == 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}

      - name: Setup Gradle
        if: steps.check-publish.outputs.result == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Publish to Maven with Gradle
        if: steps.check-publish.outputs.result == 'true'
        run: ./gradlew ${{ inputs.gradle_publish_command }} -Pgroup=${{ inputs.artifact_group }} -Pversion=${{ steps.pr-details.outputs.result }}
        env:
          MAVEN_USERNAME: ${{ secrets.maven_username }}
          MAVEN_PASSWORD: ${{ secrets.maven_password }}

      - name: Update comment with publish info
        if: steps.check-publish.outputs.result == 'true' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumber = ${{ steps.pr-number.outputs.result }};

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Publish to maven snapshots repository')
            );

            if (botComment) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              const commentBody = `- [x] Publish to maven snapshots repository

            Last commit published: [${pr.head.sha.substring(0, 7)}](${pr.head.repo.html_url}/commit/${pr.head.sha})

            \`\`\`kotlin
            repositories {
                maven("https://repo.plasmoverse.com/snapshots")
            }
            
            dependencies {
              compileOnly("${{ inputs.artifact_group }}:${{ inputs.artifact_id }}:${pr.head.sha}")
            }
            \`\`\``;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            }
